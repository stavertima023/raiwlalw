# Руководство по настройке системы долгов

## Текущий статус

✅ **Таблицы долгов уже созданы в Supabase**  
✅ **Триггеры и функции настроены**  
✅ **API для долгов и платежей готов**  
✅ **UI компоненты обновлены**

## Что нужно сделать

### 1. Настройка переменных окружения

Создайте файл `.env.local` в корне проекта со следующими переменными:

```env
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=https://kong-production-efec.up.railway.app
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxenl2bnN5anJmanljemJsYWh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyNDE3OTIsImV4cCI6MjA2NzgxNzc5Mn0.2f1JGzeG2125XWE9McYbSXpI-_gDX_yVEO2BnzldITI
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxenl2bnN5anJmanljemJsYWh6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MjI0MTc5MiwiZXhwIjoyMDY3ODE3NzkyfQ.Tx2TojfWfkussv0sGRIQ8cvIPxUkTDm_FhUeFMkrSpI

# Session Configuration
SESSION_SECRET=Vk7hG92@pqmGkHs9#1jLkshz8qNW0xpZzUoFqp9WYTn4=
```

### 2. Перезапуск сервера

После создания файла `.env.local` перезапустите сервер разработки:

```bash
npm run dev
```

### 3. Проверка работы

1. Откройте приложение в браузере
2. Войдите как администратор
3. Перейдите в раздел "Расходы"
4. Должна отображаться секция "Долги кассы" с:
   - Долгом Тимофея (на основе расходов Администратора)
   - Долгом Максима (на основе его расходов)
   - Кнопками "Погасить долг" и "История"

## Функциональность

### Автоматическое обновление долгов
- При добавлении расхода от "Администратора" → долг Тимофея увеличивается
- При добавлении расхода от "Максима" → долг Максима увеличивается
- При изменении или удалении расхода → долги автоматически пересчитываются

### Погашение долгов
- Нажмите "Погасить долг" на любом долге
- Введите сумму платежа (не больше текущего долга)
- Добавьте комментарий (необязательно)
- Платеж зарегистрируется, долг уменьшится

### История платежей
- Нажмите "История" для просмотра всех платежей по долгу
- Отображается сумма, дата, кто обработал, комментарий
- Показывается общая статистика: текущий долг, погашено, остаток

## Устранение неполадок

### Если долги не отображаются:
1. Проверьте, что переменные окружения настроены правильно
2. Перезапустите сервер разработки
3. Проверьте консоль браузера на ошибки
4. Откройте `/api/test` для проверки подключения к базе данных

### Если кнопки не работают:
1. Убедитесь, что таблицы `debts` и `debt_payments` существуют в Supabase
2. Проверьте, что триггер `expenses_debts_trigger` активен
3. Проверьте права доступа (RLS политики)

## Структура базы данных

### Таблица `debts`
- `id` - UUID, первичный ключ
- `person_name` - TEXT, имя должника (Тимофей/Максим)
- `current_amount` - NUMERIC, текущая сумма долга
- `created_at` - TIMESTAMP, дата создания
- `updated_at` - TIMESTAMP, дата обновления

### Таблица `debt_payments`
- `id` - UUID, первичный ключ
- `debt_id` - UUID, ссылка на долг
- `payment_amount` - NUMERIC, сумма платежа
- `remaining_debt` - NUMERIC, остаток после платежа
- `payment_date` - TIMESTAMP, дата платежа
- `comment` - TEXT, комментарий
- `processed_by` - TEXT, кто обработал платеж

## Логика работы

1. **Расходы Администратора** → Долг Тимофея
2. **Расходы Максима** → Долг Максима
3. **Платежи** → Уменьшают соответствующий долг
4. **История** → Показывает все платежи по долгу 