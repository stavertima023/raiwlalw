# Система аналитики для администратора

## Описание

Создана расширенная система аналитики для администраторов с следующим функционалом:

### Основные возможности:

1. **Общая статистика заказов:**
   - Общее количество заказов
   - Количество заказов по статусам:
     - Добавлен
     - Готов
     - Отправлен
     - Исполнен
     - Отменен
     - Возврат

2. **Финансовая аналитика:**
   - Общая сумма выводов
   - Средняя цена заказов
   - Сумма расходов по категориям:
     - Аренда
     - Зарплата
     - Расходники
     - Маркетинг
     - Налоги
     - Ткань
     - Курьер
     - Расходники швейки
     - Другое

3. **Фильтрация данных:**
   - По датам (от и до)
   - По продавцам (выбор конкретных продавцов)

## Компоненты системы

### 1. API Endpoint
- **Путь:** `/api/analytics`
- **Метод:** GET
- **Параметры запроса:**
  - `dateFrom` (опционально) - дата начала фильтрации
  - `dateTo` (опционально) - дата окончания фильтрации  
  - `sellers` (опционально) - список продавцов через запятую

### 2. Компонент интерфейса
- **Файл:** `src/components/admin/Analytics.tsx`
- **Функции:**
  - Отображение KPI карточек с ключевыми показателями
  - Таблица статистики заказов по статусам
  - Таблица расходов по категориям
  - Интерактивные фильтры по дате и продавцам
  - Автоматическое обновление данных

### 3. Типы данных
- **Файл:** `src/lib/types.ts`
- **Новые типы:**
  - `AnalyticsData` - структура аналитических данных
  - `AnalyticsFilters` - параметры фильтрации

## Установка и настройка

### 1. Обновление базы данных

Выполните следующие SQL скрипты в Supabase в указанном порядке:

#### Обновление категорий расходов:
```sql
-- Файл: update-expense-categories.sql
ALTER TYPE public.expense_category ADD VALUE IF NOT EXISTS 'Ткань';
ALTER TYPE public.expense_category ADD VALUE IF NOT EXISTS 'Курьер'; 
ALTER TYPE public.expense_category ADD VALUE IF NOT EXISTS 'Расходники швейки';
ALTER TYPE public.expense_category ADD VALUE IF NOT EXISTS 'Другое';
```

#### Создание таблиц для кэширования и снимков аналитики:
```sql
-- Файл: analytics-tables.sql
-- (Содержит создание analytics_cache и analytics_snapshots таблиц)
```

### 2. Проверка доступа

Убедитесь, что у вас есть:
- Роль "Администратор" в системе
- Доступ к разделу "Аналитика" в боковом меню

## Использование

### Доступ к аналитике:
1. Войдите в систему как администратор
2. Выберите "Аналитика" в боковом меню
3. Настройте фильтры по необходимости:
   - Выберите период (дата от/до)
   - Выберите конкретных продавцов или оставьте "Все продавцы"
4. Система автоматически обновит все показатели

### Интерпретация данных:

#### KPI Карточки:
- **Общее количество заказов** - количество заказов за выбранный период
- **Общая сумма выводов** - сумма всех выплат продавцам
- **Средняя цена заказа** - среднее арифметическое цен всех заказов
- **Общая сумма расходов** - сумма всех расходов по всем категориям

#### Таблица заказов по статусам:
- Показывает количество и процентное соотношение заказов для каждого статуса
- Помогает понять эффективность процесса выполнения заказов

#### Таблица расходов по категориям:
- Показывает сумму и процентное соотношение расходов по категориям
- Отображаются только категории с расходами > 0
- Сортировка по убыванию суммы расходов

## Производительность

### Кэширование:
- Система может использовать таблицу `analytics_cache` для кэширования часто запрашиваемых данных
- Кэш автоматически истекает через заданное время (по умолчанию 1 час)
- Функция `clean_expired_analytics_cache()` очищает устаревшие записи

### Снимки:
- Таблица `analytics_snapshots` позволяет сохранять исторические данные
- Можно создавать ежедневные/еженедельные/месячные снимки для долгосрочного анализа

## Техническая информация

### Структура запросов:
1. **Заказы:** фильтрация по `orderDate` и `seller`
2. **Выводы:** фильтрация по `date` и `seller`  
3. **Расходы:** фильтрация по `date` (продавец не применяется)

### Безопасность:
- Доступ только для пользователей с ролью "Администратор"
- Row Level Security (RLS) политики ограничивают доступ
- Все запросы проходят через защищенный API

### Возможные расширения:
1. Добавление графиков и диаграмм
2. Экспорт данных в Excel/PDF
3. Настраиваемые периоды (последние 7 дней, месяц, квартал)
4. Уведомления о важных показателях
5. Сравнение периодов
6. Аналитика по товарам/размерам

## Troubleshooting

### Общие проблемы:

1. **Данные не загружаются:**
   - Проверьте роль пользователя (должна быть "Администратор")
   - Убедитесь в корректности RLS политик в Supabase

2. **Неточные данные:**
   - Проверьте формат дат в фильтрах
   - Убедитесь, что категории расходов обновлены в базе данных

3. **Медленная работа:**
   - Рассмотрите использование кэширования
   - Оптимизируйте индексы на таблицах

4. **Ошибки в категориях расходов:**
   - Выполните скрипт `update-expense-categories.sql`
   - Проверьте соответствие ENUM значений в базе и коде 